{% extends 'core/base.html' %}
{% load static %}
{% load activity_filters %}

{% block title %}üéØ Votre Plan d'Entra√Ænement{% endblock %}

{% block extra_css %}
<style>
    .hero-section {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        padding: 3rem 0;
        margin-bottom: 2rem;
    }
    .plan-card {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    .analysis-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 1rem;
    }
    .recommendation-item {
        background: #f8f9fa;
        border-left: 4px solid #28a745;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 0 8px 8px 0;
    }
    .btn-new-plan {
        background: linear-gradient(45deg, #667eea, #764ba2);
        border: none;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        transition: all 0.3s ease;
    }
    .btn-new-plan:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        color: white;
    }
    .goal-badge {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: bold;
        display: inline-block;
        margin-bottom: 1rem;
    }
    .stat-highlight {
        color: #3498db;
        font-weight: bold;
    }
    .agent-response {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
    }
    .agent-content {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        line-height: 1.6;
        font-size: 16px;
        color: #2c3e50;
        white-space: pre-wrap;
    }
    .agent-content h1, .agent-content h2, .agent-content h3, .agent-content h4 {
        color: #2c3e50;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        font-weight: 600;
    }
    .agent-content h2 {
        border-bottom: 3px solid #3498db;
        padding-bottom: 0.5rem;
        font-size: 1.5rem;
    }
    .agent-content h3 {
        border-bottom: 2px solid #16a085;
        padding-bottom: 0.3rem;
        font-size: 1.3rem;
        color: #16a085;
    }
    .agent-content h4 {
        color: #e67e22;
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
    }
    
    /* Styles am√©lior√©s pour les tableaux d'entra√Ænement */
    .agent-content table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin: 1.5rem 0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        overflow: hidden;
        background: white;
    }
    .agent-content table th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: 600;
        padding: 1rem 0.75rem;
        text-align: center;
        font-size: 0.9rem;
        letter-spacing: 0.5px;
        position: relative;
    }
    .agent-content table th:first-child {
        border-top-left-radius: 8px;
    }
    .agent-content table th:last-child {
        border-top-right-radius: 8px;
    }
    .agent-content table td {
        padding: 0.75rem;
        border-bottom: 1px solid #e9ecef;
        text-align: center;
        vertical-align: middle;
        transition: background-color 0.2s ease;
    }
    .agent-content table tr:hover td {
        background-color: #f8f9fa;
    }
    .agent-content table tr:nth-child(even) td {
        background-color: #fbfcfd;
    }
    .agent-content table tr:last-child td:first-child {
        border-bottom-left-radius: 8px;
    }
    .agent-content table tr:last-child td:last-child {
        border-bottom-right-radius: 8px;
    }
    
    /* Styles pour les colonnes sp√©cifiques */
    .agent-content table td:first-child {
        font-weight: 600;
        background-color: #f1f3f4 !important;
        color: #2c3e50;
    }
    .agent-content table td:nth-child(2) {
        font-weight: 500;
        color: #27ae60;
    }
    .agent-content table td:nth-child(3) {
        color: #e74c3c;
        font-weight: 500;
    }
    .agent-content table td:nth-child(4) {
        color: #8e44ad;
        font-weight: 500;
    }
    
    /* Typographie am√©lior√©e */
    .agent-content strong {
        color: #2c3e50;
        font-weight: 700;
    }
    .agent-content em {
        color: #7f8c8d;
        font-style: italic;
    }
    .agent-content p {
        margin-bottom: 1rem;
        line-height: 1.7;
    }
    .agent-content ul, .agent-content ol {
        margin-left: 1.5rem;
        margin-bottom: 1rem;
    }
    .agent-content li {
        margin-bottom: 0.5rem;
        line-height: 1.6;
    }
    
    /* Styles sp√©cifiques pour les tableaux d'entra√Ænement */
    .agent-content .schedule-table {
        border: 2px solid #16a085;
    }
    .agent-content .schedule-table th {
        background: linear-gradient(135deg, #16a085 0%, #27ae60 100%);
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .agent-content .schedule-table td:first-child {
        background: linear-gradient(135deg, #ecf0f1 0%, #bdc3c7 100%) !important;
        font-weight: 700;
        color: #2c3e50;
        text-align: center;
    }
    .agent-content .schedule-table td:nth-child(2) {
        color: #16a085;
        font-weight: 600;
    }
    
    /* Animation hover pour les lignes de planning */
    .agent-content .schedule-table tr {
        transition: all 0.3s ease;
    }
    .agent-content .schedule-table tr:hover {
        transform: translateX(5px);
        box-shadow: -5px 0 15px rgba(22, 160, 133, 0.2);
    }
    
    
    /* Responsive design pour les tableaux */
    @media (max-width: 768px) {
        .agent-content table {
            font-size: 0.8rem;
        }
        .agent-content table th,
        .agent-content table td {
            padding: 0.5rem 0.3rem;
        }
        .agent-content .schedule-table tr:hover {
            transform: none;
            box-shadow: none;
        }
    }
    
    /* Am√©lioration de l'affichage des nombres et unit√©s */
    .agent-content .numeric-value {
        font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
        font-weight: 600;
        background: rgba(52, 152, 219, 0.1);
        border-radius: 4px;
        padding: 2px 6px;
    }
    
    /* Styles pour le contenu markdown converti */
    .markdown-content {
        line-height: 1.6;
    }
    .markdown-content h1, .markdown-content h2, .markdown-content h3, .markdown-content h4 {
        color: #2c3e50;
        margin: 1.5rem 0 1rem 0;
        font-weight: 600;
    }
    .markdown-content h1 { font-size: 1.8rem; border-bottom: 2px solid #16a085; padding-bottom: 0.5rem; }
    .markdown-content h2 { font-size: 1.5rem; color: #16a085; }
    .markdown-content h3 { font-size: 1.3rem; }
    .markdown-content h4 { font-size: 1.1rem; }
    
    .markdown-content ul, .markdown-content ol {
        padding-left: 2rem;
        margin: 1rem 0;
    }
    .markdown-content li {
        margin: 0.5rem 0;
        line-height: 1.5;
    }
    .markdown-content strong {
        color: #e74c3c;
        font-weight: 600;
    }
    .markdown-content em {
        color: #8e44ad;
        font-style: italic;
    }
    .markdown-content p {
        margin: 1rem 0;
        text-align: justify;
    }
    .markdown-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
    }
    .markdown-content table th, .markdown-content table td {
        padding: 0.8rem;
        text-align: left;
        border-bottom: 1px solid #ecf0f1;
    }
    .markdown-content table th {
        background: #16a085;
        color: white;
        font-weight: 600;
    }
    .markdown-content table tr:hover {
        background: rgba(22, 160, 133, 0.05);
    }
    
    /* Styles pour les types d'entra√Ænement */
    .agent-content .training-endurance {
        border-left: 4px solid #27ae60 !important;
        background: rgba(39, 174, 96, 0.1) !important;
    }
    .agent-content .training-interval {
        border-left: 4px solid #e74c3c !important;
        background: rgba(231, 76, 60, 0.1) !important;
    }
    .agent-content .training-recovery {
        border-left: 4px solid #3498db !important;
        background: rgba(52, 152, 219, 0.1) !important;
    }
    .agent-content .training-rest {
        border-left: 4px solid #95a5a6 !important;
        background: rgba(149, 165, 166, 0.1) !important;
        font-style: italic;
    }
    
    /* Styles pour le tableau structur√© */
    .schedule-table-structured {
        border: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border-radius: 12px;
        overflow: hidden;
        background: white;
        margin-bottom: 0;
    }
    
    .schedule-table-structured thead th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: 600;
        padding: 1rem 0.75rem;
        border: none;
        text-align: center;
        font-size: 0.9rem;
        letter-spacing: 0.5px;
    }
    
    .schedule-table-structured tbody td {
        padding: 0.75rem;
        border: none;
        border-bottom: 1px solid #f1f3f4;
        vertical-align: middle;
        transition: all 0.2s ease;
    }
    
    .schedule-table-structured tbody tr:hover {
        background-color: #f8f9fa;
        transform: translateX(3px);
        box-shadow: -3px 0 10px rgba(102, 126, 234, 0.1);
    }
    
    .day-cell {
        background: linear-gradient(135deg, #ecf0f1 0%, #bdc3c7 100%) !important;
        font-weight: 700;
        color: #2c3e50;
        text-align: center;
        min-width: 100px;
    }
    
    .type-cell {
        text-align: center;
        min-width: 140px;
    }
    
    .duration-cell {
        text-align: center;
        font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
        font-weight: 600;
        min-width: 80px;
    }
    
    .description-cell {
        max-width: 250px;
        font-size: 0.9rem;
        line-height: 1.4;
    }
    
    .intensity-cell {
        text-align: center;
        font-size: 0.85rem;
        min-width: 100px;
    }
    
    /* Badges pour les types d'entra√Ænement */
    .training-badge-endurance {
        background: linear-gradient(45deg, #27ae60, #2ecc71);
        color: white;
        padding: 0.3rem 0.6rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .training-badge-fractionne,
    .training-badge-interval {
        background: linear-gradient(45deg, #e74c3c, #ec7063);
        color: white;
        padding: 0.3rem 0.6rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .training-badge-recuperation,
    .training-badge-recovery {
        background: linear-gradient(45deg, #3498db, #5dade2);
        color: white;
        padding: 0.3rem 0.6rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .training-badge-repos {
        background: linear-gradient(45deg, #95a5a6, #bdc3c7);
        color: white;
        padding: 0.3rem 0.6rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        font-style: italic;
    }
    
    .training-badge-tempo,
    .training-badge-sortie {
        background: linear-gradient(45deg, #f39c12, #f5b041);
        color: white;
        padding: 0.3rem 0.6rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    /* R√©sum√© du planning */
    .schedule-summary {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 10px;
        padding: 1.5rem;
    }
    
    .summary-stat {
        padding: 0.5rem;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #667eea;
        line-height: 1;
    }
    
    .stat-label {
        font-size: 0.9rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 0.25rem;
    }
    
    /* Section des conseils d√©taill√©s */
    .agent-content-section {
        border-top: 2px solid #e9ecef;
        padding-top: 1.5rem;
        margin-top: 2rem;
    }
    
    .agent-content-section .agent-content {
        max-height: 300px;
        overflow-y: auto;
        font-size: 0.9rem;
        line-height: 1.6;
    }
</style>
{% endblock %}

{% block content %}
<!-- Section Hero -->
<div class="hero-section">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto text-center">
                <h1 class="display-4 mb-3">üéØ Votre Plan Personnalis√©</h1>
                <p class="lead">
                    Plan g√©n√©r√© avec succ√®s ! Voici vos recommandations d'entra√Ænement personnalis√©es.
                </p>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Plan principal -->
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="plan-card">
                <div class="text-center mb-4">
                    <span class="goal-badge">{{ plan.title|default:"Plan Personnalis√©" }}</span>
                </div>
                
                <h3 class="text-center mb-4">üìã Votre Programme</h3>
                
                <div class="row">
                    <div class="col-md-8">
                        <h5>Description du plan :</h5>
                        <!-- Affichage avec formatage Markdown pour Coach Michael -->
                        <div class="plan-content">
                            {% if plan.generated_by and "Coach Michael" in plan.generated_by %}
                                <!-- R√©ponse de l'agent avanc√© - formatage sp√©cial -->
                                <div class="agent-response">
                                    <div class="alert alert-info mb-3">
                                        <i class="fas fa-robot me-2"></i>
                                        <strong>{{ plan.generated_by }}</strong> - Analyse personnalis√©e avec base de connaissances
                                    </div>
                                    
                                    <!-- Nouveau: Planning structur√© -->
                                    {% if plan.training_schedule.schedule %}
                                    <div class="structured-schedule mb-4">
                                        <h4 class="mb-3">üìÖ Planning d'Entra√Ænement</h4>
                                        <div class="table-responsive">
                                            <table class="table table-hover schedule-table-structured">
                                                <thead>
                                                    <tr>
                                                        <th><i class="fas fa-calendar-day me-1"></i>Jour</th>
                                                        <th><i class="fas fa-running me-1"></i>Type de S√©ance</th>
                                                        <th><i class="fas fa-clock me-1"></i>Dur√©e</th>
                                                        <th><i class="fas fa-info-circle me-1"></i>Description</th>
                                                        <th><i class="fas fa-tachometer-alt me-1"></i>Intensit√©</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for session in plan.training_schedule.schedule %}
                                                    <tr class="session-row session-{{ session.type|lower|default:'other' }}">
                                                        <td class="day-cell">
                                                            {% if session.week > 1 %}
                                                                <small class="text-muted">S{{ session.week }}</small><br>
                                                            {% endif %}
                                                            <strong>{{ session.day }}</strong>
                                                        </td>
                                                        <td class="type-cell">
                                                            {% if session.type %}
                                                                <span class="badge training-badge-{{ session.type|lower }}">
                                                                    {{ session.type }}
                                                                </span>
                                                            {% else %}
                                                                <span class="text-muted">-</span>
                                                            {% endif %}
                                                        </td>
                                                        <td class="duration-cell">
                                                            {% if session.duration %}
                                                                <span class="duration-value">{{ session.duration }}</span>
                                                            {% else %}
                                                                <span class="text-muted">-</span>
                                                            {% endif %}
                                                        </td>
                                                        <td class="description-cell">
                                                            {{ session.description|truncatechars:100 }}
                                                        </td>
                                                        <td class="intensity-cell">
                                                            {% if session.intensity %}
                                                                {{ session.intensity }}
                                                            {% else %}
                                                                <span class="text-muted">-</span>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        
                                        <div class="schedule-summary mt-3">
                                            <div class="row text-center">
                                                <div class="col-md-4">
                                                    <div class="summary-stat">
                                                        <div class="stat-number">{{ plan.training_schedule.total_weeks }}</div>
                                                        <div class="stat-label">Semaine{{ plan.training_schedule.total_weeks|pluralize }}</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="summary-stat">
                                                        <div class="stat-number">{{ plan.training_schedule.total_sessions }}</div>
                                                        <div class="stat-label">S√©ance{{ plan.training_schedule.total_sessions|pluralize }} actives</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="summary-stat">
                                                        <div class="stat-number">{{ plan.training_schedule.sessions_per_week|default:plan.weekly_sessions }}</div>
                                                        <div class="stat-label">Par semaine</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                </div>
                            {% else %}
                                <!-- R√©ponse standard -->
                                <div class="markdown-content">
                                    {{ plan.description|markdown_to_html }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Conseils d√©taill√©s du Coach - Section s√©par√©e pour une meilleure lisibilit√© -->
                        {% if plan.generated_by and "Coach Michael" in plan.generated_by %}
                        <div class="mt-4">
                            <h5 class="mb-3">
                                <i class="fas fa-user-tie text-primary me-2"></i>
                                Conseils D√©taill√©s du Coach
                            </h5>
                            <div class="agent-content-section">
                                <div class="agent-content markdown-content">
                                    {{ plan.description|markdown_to_html }}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <h5 class="mt-4">Fr√©quence :</h5>
                        <p><strong class="stat-highlight">{{ plan.weekly_sessions }} s√©ances par semaine</strong></p>
                        
                        {% if form_data.target_date %}
                        <h5>Objectif cible :</h5>
                        <p>{{ form_data.target_date|date:"d F Y" }}</p>
                        {% endif %}
                        
                        {% if form_data.additional_notes %}
                        <h5>Vos notes :</h5>
                        <p class="text-muted">{{ form_data.additional_notes }}</p>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-4">
                        <h5>R√©capitulatif :</h5>
                        <ul class="list-unstyled">
                            <li><strong>Objectif :</strong> {{ form_data.goal|upper }}</li>
                            <li><strong>Niveau :</strong> {{ form_data.level|capfirst }}</li>
                            <li><strong>Fr√©quence :</strong> {{ form_data.sessions_per_week }}/semaine</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recommandations -->
    {% if plan.recommendations %}
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="plan-card">
                <h3 class="mb-4">üí° Recommandations Importantes</h3>
                {% for recommendation in plan.recommendations %}
                <div class="recommendation-item">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    {{ recommendation }}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Analyse des donn√©es utilisateur -->
    {% if user_data.total_activities > 0 %}
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="plan-card">
                <h3 class="mb-4">üìä Analyse de Vos Donn√©es</h3>
                <div class="row">
                    <div class="col-md-3">
                        <div class="analysis-card text-center">
                            <div class="stat-highlight" style="font-size: 1.5rem;">{{ user_data.total_activities }}</div>
                            <div class="text-muted">Courses analys√©es</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="analysis-card text-center">
                            <div class="stat-highlight" style="font-size: 1.5rem;">{{ user_data.avg_distance_km }}km</div>
                            <div class="text-muted">Distance moyenne</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="analysis-card text-center">
                            <div class="stat-highlight" style="font-size: 1.5rem;">{{ user_data.avg_duration_min }}min</div>
                            <div class="text-muted">Dur√©e moyenne</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="analysis-card text-center">
                            <div class="stat-highlight" style="font-size: 1.5rem;">{{ user_data.max_distance_km }}km</div>
                            <div class="text-muted">Distance max</div>
                        </div>
                    </div>
                </div>
                
                {% if user_data.recent_activities %}
                <h5 class="mt-4">Activit√©s r√©centes analys√©es :</h5>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Activit√©</th>
                                <th>Distance</th>
                                <th>Dur√©e</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for activity in user_data.recent_activities|slice:":5" %}
                            <tr>
                                <td>{{ activity.date }}</td>
                                <td>{{ activity.name }}</td>
                                <td>{{ activity.distance }}km</td>
                                <td>{{ activity.duration_min }}min</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Actions -->
    <div class="row justify-content-center">
        <div class="col-lg-6 text-center">
            <div class="plan-card">
                <h4 class="mb-3">üöÄ Et maintenant ?</h4>
                <p class="mb-4">Votre plan est pr√™t ! Vous pouvez maintenant commencer votre entra√Ænement ou g√©n√©rer un nouveau plan avec d'autres param√®tres.</p>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                    {% if saved_plan %}
                    <div class="alert alert-success text-center mb-3">
                        <i class="fas fa-save me-2"></i>
                        <strong>Plan sauvegard√© !</strong> 
                        Plan sauvegard√© en lecture seule
                    </div>
                    {% endif %}
                    
                    <a href="{% url 'coaching:simple_plan_generator' %}" class="btn btn-new-plan">
                        <i class="fas fa-redo me-2"></i>Nouveau Plan
                    </a>
                    <a href="{% url 'coaching:plan_list' %}" class="btn btn-outline-success">
                        <i class="fas fa-list me-2"></i>Mes Plans
                    </a>
                    <a href="{% url 'activities:dashboard' %}" class="btn btn-outline-primary">
                        <i class="fas fa-chart-line me-2"></i>Voir mes Stats
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Animation d'apparition progressive
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.plan-card, .analysis-card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 200);
    });
    
    // Am√©lioration du rendu pour les r√©ponses de Coach Michael
    const agentContent = document.querySelector('.agent-content');
    if (agentContent) {
        formatCoachResponse(agentContent);
    }
});

function parseMarkdownToHTML(markdown) {
    let html = markdown;
    
    // √âtape 1: Traiter les tableaux Markdown
    html = parseMarkdownTables(html);
    
    // √âtape 2: Traiter les titres
    html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
    html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
    html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
    
    // √âtape 3: Traiter le texte en gras et italique
    html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    html = html.replace(/\*([^*\n]+?)\*/g, '<em>$1</em>');
    
    // √âtape 4: Traiter les listes
    html = parseMarkdownLists(html);
    
    // √âtape 5: Traiter les paragraphes
    html = parseMarkdownParagraphs(html);
    
    return html;
}

function parseMarkdownTables(text) {
    const lines = text.split('\n');
    let result = [];
    let inTable = false;
    let tableHeaders = [];
    let tableRows = [];
    let skipNextHeaderLine = false;
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        
        // D√©tecter une ligne de tableau (contient | et au moins 2 colonnes)
        if (line.includes('|') && line.split('|').filter(cell => cell.trim() !== '').length >= 2) {
            const cells = line.split('|')
                .map(cell => cell.trim())
                .filter(cell => cell !== '');
            
            // Ignorer les lignes de s√©paration (avec des tirets)
            if (cells.some(cell => cell.match(/^[-:]+$/))) {
                continue; // Ligne de s√©paration, on l'ignore
            }
            
            // V√©rifier si c'est une ligne de headers dupliqu√©e (contient Jour, Type, Dur√©e, etc.)
            const cellsText = cells.map(c => c.toLowerCase()).join(' ');
            const isDuplicateHeader = (cellsText.includes('jour') && 
                                     (cellsText.includes('type') || cellsText.includes('s√©ance') || cellsText.includes('session'))) ||
                                    (cellsText.includes('day') && cellsText.includes('type')) ||
                                    (cellsText.includes('dur√©e') && cellsText.includes('intensit√©')) ||
                                    (cells.length >= 4 && cells.every(cell => cell.length < 15 && 
                                     /^\s*(jour|day|type|s√©ance|session|dur√©e|duration|description|intensit√©|intensity)\s*$/i.test(cell.toLowerCase())));
            
            if (isDuplicateHeader) {
                continue; // Ignorer compl√®tement les headers dupliqu√©s par l'agent
            }
            
            if (!inTable) {
                // Premi√®re ligne du tableau - on utilise nos headers HTML
                inTable = true;
                tableHeaders = []; // Headers vides car on utilise ceux en HTML
                tableRows = [];
                // Si c'est une ligne de header dupliqu√©e, on l'ignore
                if (isDuplicateHeader) {
                    continue;
                }
            }
            
            // Ligne de donn√©es (pas de headers)
            tableRows.push(cells);
        } else {
            // Fin du tableau ou ligne normale
            if (inTable) {
                // Construire le tableau HTML sans headers (on utilise ceux du HTML)
                let tableHtml = '<table class="table table-striped training-table schedule-table-structured">\n';
                
                // Pas de headers car ils sont d√©j√† dans le HTML du template
                
                // Body seulement
                if (tableRows.length > 0) {
                    tableHtml += '<tbody>\n';
                    tableRows.forEach(row => {
                        tableHtml += '<tr>\n';
                        row.forEach((cell, index) => {
                            let cellClass = '';
                            if (index === 0) cellClass = 'day-cell';
                            else if (index === 1) cellClass = 'type-cell';
                            else if (index === 2) cellClass = 'duration-cell';
                            else if (index === 3) cellClass = 'description-cell';
                            else if (index === 4) cellClass = 'intensity-cell';
                            
                            tableHtml += `<td class="${cellClass}">${cell}</td>\n`;
                        });
                        tableHtml += '</tr>\n';
                    });
                    tableHtml += '</tbody>\n';
                }
                
                tableHtml += '</table>\n';
                result.push(tableHtml);
                
                inTable = false;
                tableHeaders = [];
                tableRows = [];
            }
            
            if (line !== '') {
                result.push(line);
            }
        }
    }
    
    // G√©rer le cas o√π le texte se termine par un tableau
    if (inTable && tableRows.length > 0) {
        let tableHtml = '<table class="table table-striped training-table schedule-table-structured">\n';
        
        // Pas de headers car ils sont d√©j√† dans le HTML du template
        
        tableHtml += '<tbody>\n';
        tableRows.forEach(row => {
            tableHtml += '<tr>\n';
            row.forEach((cell, index) => {
                let cellClass = '';
                if (index === 0) cellClass = 'day-cell';
                else if (index === 1) cellClass = 'type-cell';
                else if (index === 2) cellClass = 'duration-cell';
                else if (index === 3) cellClass = 'description-cell';
                else if (index === 4) cellClass = 'intensity-cell';
                
                tableHtml += `<td class="${cellClass}">${cell}</td>\n`;
            });
            tableHtml += '</tr>\n';
        });
        tableHtml += '</tbody>\n';
        
        tableHtml += '</table>\n';
        result.push(tableHtml);
    }
    
    return result.join('\n');
}

function parseMarkdownLists(text) {
    // Traiter les listes √† puces
    let lines = text.split('\n');
    let result = [];
    let inList = false;
    let listItems = [];
    
    for (let line of lines) {
        if (line.trim().match(/^[-*+] /)) {
            if (!inList) {
                inList = true;
                listItems = [];
            }
            listItems.push(line.trim().substring(2));
        } else {
            if (inList) {
                result.push('<ul>');
                listItems.forEach(item => {
                    result.push(`<li>${item}</li>`);
                });
                result.push('</ul>');
                inList = false;
                listItems = [];
            }
            if (line.trim() !== '') {
                result.push(line);
            }
        }
    }
    
    // G√©rer le cas o√π le texte se termine par une liste
    if (inList) {
        result.push('<ul>');
        listItems.forEach(item => {
            result.push(`<li>${item}</li>`);
        });
        result.push('</ul>');
    }
    
    return result.join('\n');
}

function parseMarkdownParagraphs(text) {
    // Diviser en blocs s√©par√©s par des lignes vides
    let blocks = text.split('\n\n').filter(block => block.trim() !== '');
    let result = [];
    
    for (let block of blocks) {
        block = block.trim();
        
        // Ne pas encapsuler les √©l√©ments HTML existants dans des paragraphes
        if (block.match(/^<(h[1-6]|table|ul|ol|div)/i)) {
            result.push(block);
        } else if (block !== '') {
            result.push(`<p>${block.replace(/\n/g, '<br>')}</p>`);
        }
    }
    
    return result.join('\n\n');
}

function formatCoachResponse(element) {
    let content = element.textContent || element.innerText || '';
    
    // Nettoyer le contenu d'abord
    content = content.trim();
    
    // Parser Markdown complet et robuste
    content = parseMarkdownToHTML(content);
    
    element.innerHTML = content;
    
    // Ajouter des classes sp√©cifiques aux tableaux d'entra√Ænement
    const tables = element.querySelectorAll('table');
    tables.forEach(table => {
        table.classList.add('training-table');
        
        // D√©tecter si c'est un tableau d'entra√Ænement (contient Jour, S√©ance, etc.)
        const headers = table.querySelectorAll('th');
        if (headers.length > 0) {
            const headerText = Array.from(headers).map(h => h.textContent.toLowerCase()).join(' ');
            if (headerText.includes('jour') || headerText.includes('s√©ance') || headerText.includes('type') || 
                headerText.includes('distance') || headerText.includes('dur√©e') || headerText.includes('allure')) {
                table.classList.add('schedule-table');
            }
        }
        
        // Am√©liorer l'affichage des cellules avec unit√©s
        const cells = table.querySelectorAll('td');
        cells.forEach(cell => {
            const text = cell.textContent.trim();
            // D√©tecter les valeurs num√©riques avec unit√©s
            if (text.match(/\d+(\.\d+)?\s*(km|min|km\/h|bpm)/i)) {
                cell.classList.add('numeric-value');
            }
            // D√©tecter les types d'entra√Ænement pour les couleurs
            if (text.toLowerCase().includes('endurance')) {
                cell.classList.add('training-endurance');
            } else if (text.toLowerCase().includes('fractionne') || text.toLowerCase().includes('fractionn√©') || text.toLowerCase().includes('interval')) {
                cell.classList.add('training-interval');
            } else if (text.toLowerCase().includes('r√©cup√©ration') || text.toLowerCase().includes('recovery')) {
                cell.classList.add('training-recovery');
            } else if (text.toLowerCase().includes('repos')) {
                cell.classList.add('training-rest');
            }
        });
    });
}
</script>
{% endblock %}